<!doctype html><html class="theme-next pisces" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css"><meta name="keywords" content="Hexo, NexT"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0"><meta name="description" content="环境配置下载github源码安装mac os配置123在 .bash_profile 添加export PATH=$PATH:/Users/peter/Downloads/protoc-3.3.0-osx-x86_64/bin验证12protoc --versionlibprotoc 3.3.0消息模型（.proto文件）12345678910111213141516171819202122232"><meta property="og:type" content="article"><meta property="og:title" content="Protocol Buffers分享"><meta property="og:url" content="http://yoursite.com/2017/06/21/protocol buffer分享/index.html"><meta property="og:site_name" content="200code"><meta property="og:description" content="环境配置下载github源码安装mac os配置123在 .bash_profile 添加export PATH=$PATH:/Users/peter/Downloads/protoc-3.3.0-osx-x86_64/bin验证12protoc --versionlibprotoc 3.3.0消息模型（.proto文件）12345678910111213141516171819202122232"><meta property="og:updated_time" content="2017-06-23T05:55:32.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Protocol Buffers分享"><meta name="twitter:description" content="环境配置下载github源码安装mac os配置123在 .bash_profile 添加export PATH=$PATH:/Users/peter/Downloads/protoc-3.3.0-osx-x86_64/bin验证12protoc --versionlibprotoc 3.3.0消息模型（.proto文件）12345678910111213141516171819202122232"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Pisces",sidebar:{position:"left",display:"always"},fancybox:!1,motion:!1,duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://yoursite.com/2017/06/21/protocol buffer分享/"><title>Protocol Buffers分享 | 200code</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?afd325d3333e718fc607b569c45d57a4";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><div class="container one-collumn sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">200code</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/21/protocol buffer分享/"><span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="peter"><meta itemprop="description" content=""><meta itemprop="image" content="http://7xoxmg.com1.z0.glb.clouddn.com/avatar.jpg"></span><span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="200code"><span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject"><img style="display:none" itemprop="url image" alt="200code" src=""></span></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Protocol Buffers分享</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-06-21T10:32:38+08:00">2017-06-21 </time></span><span class="post-comments-count"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span><a class="cloud-tie-join-count" href="/2017/06/21/protocol buffer分享/#comments" itemprop="discussionUrl"><span class="post-comments-count join-count" itemprop="commentCount"></span></a></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h1><h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><p><a href="https://github.com/google/protobuf" target="_blank" rel="external">github源码</a></p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p><a href="https://github.com/google/protobuf/releases/download/v3.3.0/protoc-3.3.0-osx-x86_64.zip" target="_blank" rel="external">mac os</a></p><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">在 .bash_profile 添加</div><div class="line"></div><div class="line">export PATH=$PATH:/Users/peter/Downloads/protoc-3.3.0-osx-x86_64/bin</div></pre></td></tr></table></figure><h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">protoc --version</div><div class="line">libprotoc 3.3.0</div></pre></td></tr></table></figure><hr><h1 id="消息模型（-proto文件）"><a href="#消息模型（-proto文件）" class="headerlink" title="消息模型（.proto文件）"></a>消息模型（.proto文件）</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">//1.包名</div><div class="line">package protocobuff_Demo;</div><div class="line"></div><div class="line">//2.option选项</div><div class="line">option java_package = &quot;com.peter.demo&quot;;</div><div class="line">option java_outer_classname = &quot;Demo&quot;; </div><div class="line"></div><div class="line">//3.消息模型</div><div class="line">message Person &#123;</div><div class="line">  required string name = 1;</div><div class="line">  required int32 id = 2;</div><div class="line">  optional string email = 3;</div><div class="line"></div><div class="line">  enum PhoneType &#123;</div><div class="line">    MOBILE = 0;</div><div class="line">    HOME = 1;</div><div class="line">    WORK = 2;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  message PhoneNumber &#123;</div><div class="line">    required string number = 1;</div><div class="line">    optional PhoneType type = 2 [default = HOME];</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  repeated PhoneNumber phone = 4;</div><div class="line">&#125;</div><div class="line"></div><div class="line">message AddressBook &#123;</div><div class="line">  repeated Person person = 1;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="包名"><a href="#包名" class="headerlink" title="包名"></a>包名</h2><p>防止不同 .proto 项目间命名发生冲突</p><h2 id="option选项"><a href="#option选项" class="headerlink" title="option选项"></a>option选项</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">option java_package = &quot;com.peter.demo&quot;;</div><div class="line">// Java包名,指定生成的类应该放在什么Java包名下</div><div class="line"></div><div class="line">option java_outer_classname = &quot;Demo&quot;;</div><div class="line">// 类名 生成对应.java 文件的类名（不能跟message的类名相同）</div><div class="line"></div><div class="line">option optimize_for = ***;</div><div class="line">// 1. SPEED (默认):：protocol buffer编译器将通过在消息类型上执行序列化、语法分析及其他通用的操作。（最优方式）</div><div class="line">// 2. CODE_SIZE:：编译器将会产生最少量的类，通过共享或基于反射的代码来实现序列化、语法分析及各种其它操作。</div><div class="line">  // 特点：采用该方式产生的代码将比SPEED要少很多， 但是效率较低；</div><div class="line">  // 使用场景：常用在 包含大量.proto文件 但 不追求效率 的应用中。</div><div class="line">//3.  LITE_RUNTIME:：编译器依赖于运行时 核心类库 来生成代码（即采用libprotobuf-lite 替代libprotobuf）。</div><div class="line">  // 特点：这种核心类库要比全类库小得多（忽略了 一些描述符及反射 ）；编译器采用该模式产生的方法实现与SPEED模式不相上下，产生的类通过实现 MessageLite接口，但它仅仅是Messager接口的一个子集。</div><div class="line">  // 应用场景：移动手机平台应用 v</div><div class="line"></div><div class="line">optional repeated int32 samples = 4 [packed=true];</div><div class="line">// 如果该选项在一个整型基本类型上被设置为真，则采用更紧凑的编码方式</div><div class="line"></div><div class="line">optional int32 old_field = 6 [deprecated=true];</div><div class="line">// 判断该字段是否已经被弃用 在java中的注解@Deprecated</div></pre></td></tr></table></figure><h2 id="message"><a href="#message" class="headerlink" title="message"></a>message</h2><h3 id="一个-proto文件中可定义多个消息对象"><a href="#一个-proto文件中可定义多个消息对象" class="headerlink" title="一个.proto文件中可定义多个消息对象"></a>一个.proto文件中可定义多个消息对象</h3><p>将与某一消息类型对应的响应消息格式 定义到相同的 .proto文件中<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">message SearchRequest &#123;</div><div class="line"></div><div class="line">  required string query = 1;</div><div class="line">  optional int32 page_number = 2;</div><div class="line">  optional int32 result_per_page = 3;</div><div class="line"></div><div class="line">&#125;</div><div class="line">// 与SearchRequest消息类型 对应的 响应消息类型SearchResponse</div><div class="line">message SearchResponse &#123;</div><div class="line"> …</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><h3 id="消息嵌套"><a href="#消息嵌套" class="headerlink" title="消息嵌套"></a>消息嵌套</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">message Person &#123;</div><div class="line">  required string name = 1;</div><div class="line">  required int32 id = 2;</div><div class="line">  optional string email = 3;</div><div class="line"></div><div class="line">// 定义在 Person消息类型的内部</div><div class="line">  message PhoneNumber &#123;</div><div class="line">    required string number = 1;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">&lt;-- 多重嵌套 --&gt;</div><div class="line">message Outer &#123;   // Level 0</div><div class="line">  message MiddleAA &#123;  // Level 1</div><div class="line">    message Inner &#123;   // Level 2</div><div class="line">      required int64 ival = 1;</div><div class="line">      optional bool  booly = 2;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="字段"><a href="#字段" class="headerlink" title="字段"></a>字段</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">//修饰符   类型   名字   标识号</div><div class="line">required string name = 1;</div></pre></td></tr></table></figure><h3 id="字段修饰符"><a href="#字段修饰符" class="headerlink" title="字段修饰符"></a>字段修饰符</h3><p>设置该字段解析时的规则</p><table><thead><tr><th>修饰符</th><th style="text-align:right">赋值</th><th style="text-align:center">备注</th></tr></thead><tbody><tr><td>required</td><td style="text-align:right">必须赋值</td><td style="text-align:center">一个格式良好的消息一定要含有1个这种字段</td></tr><tr><td>optional</td><td style="text-align:right">可选</td><td style="text-align:center">个格式良好的消息可以有0个或1个这种字段（但不超过1个）。当解析一个消息的时候，如果它不包含optional的元素，那么解析出来的对象中的对应字段就被置为默认值。</td></tr><tr><td>repeated</td><td style="text-align:right">多次赋值</td><td style="text-align:center">在一个格式良好的消息中，这种字段可以重复任意多次（包括0次），重复的值的顺序会被保留。</td></tr></tbody></table><h3 id="字段类型（3种）"><a href="#字段类型（3种）" class="headerlink" title="字段类型（3种）"></a>字段类型（3种）</h3><h3 id="基本类型字段"><a href="#基本类型字段" class="headerlink" title="基本类型字段"></a>基本类型字段</h3><table><thead><tr><th>.proto类型</th><th>java类型</th><th style="text-align:center">备注</th></tr></thead><tbody><tr><td>double</td><td>double</td><td style="text-align:center"></td></tr><tr><td>float</td><td>float</td><td style="text-align:center"></td></tr><tr><td>int32</td><td>int</td><td style="text-align:center">使用可变长编码方式。编码负数时不够高效——如果你的字段可能含有负数，那么请使用sint32。</td></tr><tr><td>int64</td><td>long</td><td style="text-align:center">用可变长编码方式。编码负数时不够高效——如果你的字段可能含有负数，那么请使用sint64。</td></tr><tr><td>uint32</td><td>int</td><td style="text-align:center">使用可变长编码方式。</td></tr><tr><td>uint64</td><td>long</td><td style="text-align:center">使用可变长编码方式。</td></tr><tr><td>sint32</td><td>int</td><td style="text-align:center">使用可变长编码方式。有符号的整型值。编码时比通常的int32高效。</td></tr><tr><td>sint64</td><td>long</td><td style="text-align:center">使用可变长编码方式。有符号的整型值。编码时比通常的int64高效。</td></tr><tr><td>fixed32</td><td>int</td><td style="text-align:center">总是4个字节。如果数值总是比总是比228大的话，这个类型会比uint32高效。</td></tr><tr><td>fixed64</td><td>long</td><td style="text-align:center">总是8个字节。如果数值总是比总是比256大的话，这个类型会比uint64高效。</td></tr><tr><td>sfixed32</td><td>int</td><td style="text-align:center">总是4个字节。</td></tr><tr><td>sfixed64</td><td>long</td><td style="text-align:center">总是8个字节。</td></tr><tr><td>bool</td><td>boolean</td><td style="text-align:center"></td></tr><tr><td>string</td><td>String</td><td style="text-align:center">一个字符串必须是UTF-8编码或者7-bit ASCII编码的文本。</td></tr><tr><td>bytes</td><td>ByteString</td><td style="text-align:center">可能包含任意顺序的字节数据。</td></tr></tbody></table><h3 id="枚举类型字段"><a href="#枚举类型字段" class="headerlink" title="枚举类型字段"></a>枚举类型字段</h3><p>为字段指定一个 可能取值的字段集合。 该字段只能从 该指定的字段集合里 取值</p><h3 id="消息对象类型"><a href="#消息对象类型" class="headerlink" title="消息对象类型"></a>消息对象类型</h3><h4 id="内部消息"><a href="#内部消息" class="headerlink" title="内部消息"></a>内部消息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">message Person &#123;</div><div class="line">  required string name = 1;</div><div class="line">  required int32 id = 2;</div><div class="line">  optional string email = 3;</div><div class="line"></div><div class="line">// 该消息类型 定义在 Person消息类型的内部</div><div class="line">  message PhoneNumber &#123;</div><div class="line">    required string number = 1;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  repeated PhoneNumber phone = 4;</div><div class="line">  // 直接使用内部消息类型</div><div class="line">&#125;</div></pre></td></tr></table></figure><h4 id="外部消息"><a href="#外部消息" class="headerlink" title="外部消息"></a>外部消息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">message Person &#123;</div><div class="line">  required string name = 1;</div><div class="line">  required int32 id = 2;</div><div class="line">  optional string email = 3;</div><div class="line">&#125;</div><div class="line"></div><div class="line">message AddressBook &#123;</div><div class="line">  repeated Person person = 1;</div><div class="line">  // 直接使用了 Person消息类型作为消息字段</div><div class="line">&#125;</div></pre></td></tr></table></figure><h4 id="使用外部消息的内部消息类型"><a href="#使用外部消息的内部消息类型" class="headerlink" title="使用外部消息的内部消息类型"></a>使用外部消息的内部消息类型</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">message Person &#123;</div><div class="line">  required string name = 1;</div><div class="line">  required int32 id = 2;</div><div class="line">  optional string email = 3;</div><div class="line"></div><div class="line">  message PhoneNumber &#123;</div><div class="line">    required string number = 1;</div><div class="line">    optional PhoneType type = 2 [default = HOME];</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// Parent.Type 的形式去使用</div><div class="line">message OtherMessage &#123;</div><div class="line">  optional Person.PhoneNumber phonenumber = 1;</div><div class="line">// 以 Parent.Type = Person.PhoneNumber  的形式去使用</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><h4 id="使用不同-proto-文件里的消息类型"><a href="#使用不同-proto-文件里的消息类型" class="headerlink" title="使用不同 .proto 文件里的消息类型"></a>使用不同 .proto 文件里的消息类型</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">import &quot;myproject/other_protos.proto&quot;</div><div class="line">// 在A.proto 文件中添加 B.proto文件路径的导入声明</div><div class="line">// ProtocolBuffer编译器 会在 该目录中 查找需要被导入的 .proto文件</div><div class="line">// 如果不提供参数，编译器就在 其调用的目录下 查找</div></pre></td></tr></table></figure><h4 id="更新和扩展"><a href="#更新和扩展" class="headerlink" title="更新和扩展"></a>更新和扩展</h4><table><thead><tr><th>类型</th><th style="text-align:right">规则</th><th style="text-align:center">备注</th></tr></thead><tbody><tr><td>修改</td><td style="text-align:right">不要修改已有字段标识符</td><td style="text-align:center"></td></tr><tr><td>添加</td><td style="text-align:right">只能是optional或repeated</td><td style="text-align:center">旧的程序解析时只是将新的字段忽略，并未抛弃。</td></tr><tr><td>删除</td><td style="text-align:right">只能删除optional或repeated</td><td style="text-align:center">不能重复使用删除的标识符。</td></tr><tr><td>扩展</td><td style="text-align:right">非required字段可以扩展</td><td style="text-align:center">不能重复使用删除的标识符。</td></tr></tbody></table><h3 id="标识号"><a href="#标识号" class="headerlink" title="标识号"></a>标识号</h3><h4 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h4><p>通过二进制格式唯一标识每个字段</p><ul><li>一旦开始使用就不能够再改变</li><li>标识号使用范围：[1,2的29次方 - 1]</li><li>不可使用 [19000－19999] 标识号， 因为 Protobuf 协议实现中对这些标识号进行了预留。假若使用，则会报错</li></ul><h4 id="编码占有内存规则"><a href="#编码占有内存规则" class="headerlink" title="编码占有内存规则"></a>编码占有内存规则</h4><p>每个字段在进行编码时都会占用内存，而 占用内存大小 取决于 标识号<br>范围 [1,15] 标识号的字段 在编码时占用1个字节；<br>范围 [16,2047] 标识号的字段 在编码时占用2个字节</p><h4 id="建议"><a href="#建议" class="headerlink" title="建议"></a>建议</h4><p>为频繁出现的 消息字段 保留 [1,15] 的标识号<br>为将来有可能添加的、频繁出现的 消息字段预留 [1,15] 标识号</p><h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">// 在 终端 输入下列命令进行编译</div><div class="line">protoc $SRC_DIR --java_out=$DST_DIR</div><div class="line"></div><div class="line">// 参数说明</div><div class="line">// 1. $SRC_DIR：指定需要编译的.proto文件目录 (如没有提供则使用当前目录)</div><div class="line">// 2. --java_out：java根据需要生成代码的类型进行设置</div><div class="line">// 3. $DST_DIR ：编译后代码生成的目录 (通常设置与$SRC_DIR相同)</div><div class="line"></div><div class="line">查看全部命令 </div><div class="line">protoc --help</div></pre></td></tr></table></figure><hr><h1 id="命名规范"><a href="#命名规范" class="headerlink" title="命名规范"></a>命名规范</h1><h2 id="消息名和字段名"><a href="#消息名和字段名" class="headerlink" title="消息名和字段名"></a>消息名和字段名</h2><p>消息名使用驼峰法， 字段名使用下划线分隔<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">message SongServerRequest &#123;</div><div class="line">  required string song_name = 1;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><h2 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h2><p>枚举类型名使用驼峰法,值的名字使用大写加下划线分隔:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">enum Foo &#123;</div><div class="line">  FIRST_VALUE = 1;</div><div class="line">  SECOND_VALUE = 2;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><hr><h1 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h1><p>android平台下的使用</p><h2 id="添加依赖库"><a href="#添加依赖库" class="headerlink" title="添加依赖库"></a>添加依赖库</h2><p>要和protocal buffer编译库匹配<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">compile &apos;com.google.protobuf:protobuf-java:3.3.0&apos;</div></pre></td></tr></table></figure><p></p><h2 id="android-studio-plug"><a href="#android-studio-plug" class="headerlink" title="android studio plug"></a>android studio plug</h2><ul><li><a href="https://github.com/google/protobuf-gradle-plugin" target="_blank" rel="external">protobuf-gradle-plugin</a></li><li><a href="https://github.com/square/wire-gradle-plugin" target="_blank" rel="external">wire-gradle-plugin</a></li></ul><h2 id="和json之间转换"><a href="#和json之间转换" class="headerlink" title="和json之间转换"></a>和json之间转换</h2><h3 id="使用protobuf-java-format-官网"><a href="#使用protobuf-java-format-官网" class="headerlink" title="使用protobuf-java-format 官网"></a>使用protobuf-java-format <a href="https://code.google.com/archive/p/protobuf-java-format/" target="_blank" rel="external">官网</a></h3><h3 id="依赖库"><a href="#依赖库" class="headerlink" title="依赖库"></a>依赖库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">compile &apos;com.googlecode.protobuf-java-format:protobuf-java-format:1.4&apos;</div></pre></td></tr></table></figure><hr><h1 id="一些资源"><a href="#一些资源" class="headerlink" title="一些资源"></a>一些资源</h1><ul><li><a href="https://developers.google.com/protocol-buffers/docs/encoding" target="_blank" rel="external">官网编码解释</a></li><li><a href="http://www.jianshu.com/p/30ef9b3780d9" target="_blank" rel="external">Protocol Buffer 序列化原理</a></li><li><a href="https://carlmastrangelo.com/blog/lets-make-a-varint" target="_blank" rel="external">Let’s Make a Varint</a></li><li><a href="http://www.cnblogs.com/jacksu-tencent/p/3389843.html" target="_blank" rel="external">Varint编码</a></li><li><a href="https://developers.google.com/protocol-buffers/" target="_blank" rel="external">protocol buffers官网</a></li><li><a href="https://github.com/google/protobuf" target="_blank" rel="external">protocol buffers源码</a></li><li><a href="https://github.com/eishay/jvm-serializers/wiki" target="_blank" rel="external">Protobuf性能对比</a></li><li><a href="http://www.52im.net/thread-772-1-1.html" target="_blank" rel="external">Protobuf vs Json</a></li><li><a href="https://github.com/netty/netty/blob/eb7f751ba519cbcab47d640cd18757f09d077b55/example/src/main/java/io/netty/example/worldclock/WorldClockServerInitializer.java" target="_blank" rel="external">netty 官方protocol buffers demo</a></li><li><a href="https://github.com/square/retrofit/tree/master/retrofit-converters/protobuf" target="_blank" rel="external">retrofit对protocol buffers 官方支持文档</a></li><li><a href="https://developers.google.com/protocol-buffers/docs/encoding" target="_blank" rel="external">protocol buffers 编码原理</a></li></ul><h1 id="Proto3-补充"><a href="#Proto3-补充" class="headerlink" title="Proto3 补充"></a>Proto3 补充</h1><h2 id="reserved-保留字段"><a href="#reserved-保留字段" class="headerlink" title="reserved  保留字段"></a>reserved 保留字段</h2><p>当你更新消息类型,需要彻底删除一个字段时, 或者注释掉它, 未来的用户在实现他们对这个类型的更新时可以重用这个标签数字. 会导致数据冲突。保留字段可以解决这个问题。</p><h2 id="Any"><a href="#Any" class="headerlink" title="Any"></a>Any</h2><p>Any 类型替代了extensions.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">import &quot;google/protobuf/any.proto&quot;;</div><div class="line"></div><div class="line">message ErrorStatus &#123;</div><div class="line">  string message = 1;</div><div class="line">  repeated Any details = 2;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="Oneof"><a href="#Oneof" class="headerlink" title="Oneof"></a>Oneof</h2><p>如果你有一个有很多字段的消息, 而同一时间最多只有一个字段会被设值, 你可以通过使用oneof特性来强化这个行为并节约内存.<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">message SampleMessage &#123;</div><div class="line">  oneof test_oneof &#123;</div><div class="line">    string name = 4;</div><div class="line">    SubMessage sub_message = 9;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li>设置一个oneof字段会自动清除所有其他oneof成员. 所以如果设置多次oneof字段, 只有最后设置的字段依然有值.</li></ul><h2 id="Maps"><a href="#Maps" class="headerlink" title="Maps"></a>Maps</h2><p>如果想常见一个关联的map作为数据定义的一部分, protocol buffers 提供方便的快捷语法:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">map&lt;key_type, value_type&gt; map_field = N;</div></pre></td></tr></table></figure><p></p><p>key_type可以是任意整型或者字符类型(除了floating和bytes外任何简单类型).<br>value_type可以是任意类型.</p><h2 id="Wire使用"><a href="#Wire使用" class="headerlink" title="Wire使用"></a>Wire使用</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">compile &apos;com.squareup.wire:wire-runtime:2.2.0&apos;</div></pre></td></tr></table></figure></div><div></div><div></div><footer class="post-footer"><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2017/04/07/Everything every Android Developer must know about new Android's Runtime Permission(译)/" rel="next" title="Everything every Android Developer must know about new Android's Runtime Permission(译)"><i class="fa fa-chevron-left"></i> Everything every Android Developer must know about new Android's Runtime Permission(译)</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"></div></div></footer></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div></div><div class="ds-thread" data-thread-key="<%- page.path %>" data-title="<%- page.title %>" data-url="<%- page.permalink %>"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview">站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="http://7xoxmg.com1.z0.glb.clouddn.com/avatar.jpg" alt="peter"><p class="site-author-name" itemprop="name">peter</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/"><span class="site-state-item-count">21</span> <span class="site-state-item-name">日志</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/javalive09" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub </a></span><span class="links-of-author-item"><a href="http://stackoverflow.com/users/4674672/peter-zhang" target="_blank" title="Stack Overflow"><i class="fa fa-fw fa-stack-overflow"></i> Stack Overflow </a></span><span class="links-of-author-item"><a href="/about" target="_blank" title="工具网站"><i class="fa fa-fw fa-globe"></i> 工具网站</a></span></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#环境配置"><span class="nav-number">1.</span> <span class="nav-text">环境配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#下载"><span class="nav-number">1.1.</span> <span class="nav-text">下载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装"><span class="nav-number">1.2.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置"><span class="nav-number">1.3.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#验证"><span class="nav-number">1.4.</span> <span class="nav-text">验证</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#消息模型（-proto文件）"><span class="nav-number">2.</span> <span class="nav-text">消息模型（.proto文件）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#包名"><span class="nav-number">2.1.</span> <span class="nav-text">包名</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#option选项"><span class="nav-number">2.2.</span> <span class="nav-text">option选项</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#message"><span class="nav-number">2.3.</span> <span class="nav-text">message</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#一个-proto文件中可定义多个消息对象"><span class="nav-number">2.3.1.</span> <span class="nav-text">一个.proto文件中可定义多个消息对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消息嵌套"><span class="nav-number">2.3.2.</span> <span class="nav-text">消息嵌套</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#字段"><span class="nav-number">2.4.</span> <span class="nav-text">字段</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#字段修饰符"><span class="nav-number">2.4.1.</span> <span class="nav-text">字段修饰符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#字段类型（3种）"><span class="nav-number">2.4.2.</span> <span class="nav-text">字段类型（3种）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#基本类型字段"><span class="nav-number">2.4.3.</span> <span class="nav-text">基本类型字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#枚举类型字段"><span class="nav-number">2.4.4.</span> <span class="nav-text">枚举类型字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消息对象类型"><span class="nav-number">2.4.5.</span> <span class="nav-text">消息对象类型</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#内部消息"><span class="nav-number">2.4.5.1.</span> <span class="nav-text">内部消息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#外部消息"><span class="nav-number">2.4.5.2.</span> <span class="nav-text">外部消息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用外部消息的内部消息类型"><span class="nav-number">2.4.5.3.</span> <span class="nav-text">使用外部消息的内部消息类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用不同-proto-文件里的消息类型"><span class="nav-number">2.4.5.4.</span> <span class="nav-text">使用不同 .proto 文件里的消息类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#更新和扩展"><span class="nav-number">2.4.5.5.</span> <span class="nav-text">更新和扩展</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#标识号"><span class="nav-number">2.4.6.</span> <span class="nav-text">标识号</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#作用"><span class="nav-number">2.4.6.1.</span> <span class="nav-text">作用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编码占有内存规则"><span class="nav-number">2.4.6.2.</span> <span class="nav-text">编码占有内存规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#建议"><span class="nav-number">2.4.6.3.</span> <span class="nav-text">建议</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编译"><span class="nav-number">2.5.</span> <span class="nav-text">编译</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#命名规范"><span class="nav-number">3.</span> <span class="nav-text">命名规范</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#消息名和字段名"><span class="nav-number">3.1.</span> <span class="nav-text">消息名和字段名</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#枚举"><span class="nav-number">3.2.</span> <span class="nav-text">枚举</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Demo"><span class="nav-number">4.</span> <span class="nav-text">Demo</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#添加依赖库"><span class="nav-number">4.1.</span> <span class="nav-text">添加依赖库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#android-studio-plug"><span class="nav-number">4.2.</span> <span class="nav-text">android studio plug</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#和json之间转换"><span class="nav-number">4.3.</span> <span class="nav-text">和json之间转换</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用protobuf-java-format-官网"><span class="nav-number">4.3.1.</span> <span class="nav-text">使用protobuf-java-format 官网</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#依赖库"><span class="nav-number">4.3.2.</span> <span class="nav-text">依赖库</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#一些资源"><span class="nav-number">5.</span> <span class="nav-text">一些资源</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Proto3-补充"><span class="nav-number">6.</span> <span class="nav-text">Proto3 补充</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#reserved-保留字段"><span class="nav-number">6.1.</span> <span class="nav-text">reserved 保留字段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Any"><span class="nav-number">6.2.</span> <span class="nav-text">Any</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Oneof"><span class="nav-number">6.3.</span> <span class="nav-text">Oneof</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Maps"><span class="nav-number">6.4.</span> <span class="nav-text">Maps</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Wire使用"><span class="nav-number">6.5.</span> <span class="nav-text">Wire使用</span></a></li></ol></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2017</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">peter</span></div><div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div><div class="theme-info">主题 - <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script><script>var cloudTieConfig={url:document.location.href,sourceId:"",productKey:"a44a85017991439782ca46cd64b41841",target:"cloud-tie-wrapper"}</script><script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script></body></html>